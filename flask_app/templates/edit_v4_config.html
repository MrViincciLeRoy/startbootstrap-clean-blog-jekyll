{% extends "base.html" %}

{% block title %}{{ schema.label }} - Configuration Management{% endblock %}

{% block content %}
<style>
    .config-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 12px;
        margin-bottom: 2rem;
        box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
    }

    .config-header h1 {
        margin: 0;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .config-header p {
        margin: 0.5rem 0 0 0;
        opacity: 0.95;
        font-size: 0.95rem;
    }

    .config-icon {
        font-size: 2rem;
        opacity: 0.9;
    }

    .editor-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .editor-panel {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        display: flex;
        flex-direction: column;
    }

    .editor-panel-header {
        padding: 1.5rem;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .editor-panel-header h5 {
        margin: 0;
        font-weight: 600;
        color: #212529;
    }

    .editor-panel-header .badge {
        margin-left: auto;
    }

    .editor-panel-body {
        padding: 1.5rem;
        flex: 1;
        overflow-y: auto;
    }

    .json-editor {
        font-family: 'Courier New', monospace;
        width: 100%;
        min-height: 400px;
        padding: 1rem;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        font-size: 0.85rem;
        line-height: 1.6;
        resize: vertical;
        background: #f8f9fa;
        color: #212529;
    }

    .json-editor:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-section {
        margin-bottom: 2rem;
    }

    .form-section-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #e9ecef;
        color: #212529;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .form-group-custom {
        margin-bottom: 1.25rem;
        padding: 1rem;
        background: #f8f9fa;
        border-left: 3px solid #667eea;
        border-radius: 6px;
        transition: all 0.3s ease;
    }

    .form-group-custom:hover {
        background: #e7f1ff;
        border-left-color: #4c51bf;
    }

    .form-group-custom label {
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #212529;
        display: block;
    }

    .form-group-custom input,
    .form-group-custom select,
    .form-group-custom textarea {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        font-size: 0.9rem;
        transition: border 0.2s;
    }

    .form-group-custom input:focus,
    .form-group-custom select:focus,
    .form-group-custom textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .help-text {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: 0.4rem;
    }

    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 24px;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
    }

    input:checked + .slider {
        background-color: #667eea;
    }

    input:checked + .slider:before {
        transform: translateX(26px);
    }

    .action-buttons {
        display: flex;
        gap: 1rem;
        padding: 1.5rem;
        border-top: 1px solid #e9ecef;
        background: #f8f9fa;
        border-radius: 0 0 12px 12px;
    }

    .action-buttons button,
    .action-buttons a {
        flex: 1;
        padding: 0.875rem 1.5rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        text-decoration: none;
    }

    .btn-save {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-save:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
        color: white;
    }

    .btn-reset {
        background: white;
        color: #667eea;
        border: 2px solid #667eea;
    }

    .btn-reset:hover {
        background: #f0f4ff;
    }

    .info-box {
        background: linear-gradient(135deg, #e7f1ff 0%, #f0f4ff 100%);
        border-left: 4px solid #667eea;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
    }

    .info-box h6 {
        margin: 0 0 0.5rem 0;
        color: #4c51bf;
        font-weight: 600;
    }

    .info-box p {
        margin: 0;
        color: #5a67d8;
        font-size: 0.9rem;
    }

    .validation-result {
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        display: none;
    }

    .validation-result.success {
        background: #d1e7dd;
        color: #0f5132;
        border-left: 4px solid #198754;
        display: block;
    }

    .validation-result.error {
        background: #f8d7da;
        color: #842029;
        border-left: 4px solid #dc3545;
        display: block;
    }

    .toggle-editor-btn {
        background: white;
        border: 1px solid #dee2e6;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .toggle-editor-btn:hover {
        background: #e9ecef;
        border-color: #667eea;
    }

    .responsive-grid {
        display: grid;
        gap: 2rem;
    }

    @media (max-width: 1200px) {
        .editor-container {
            grid-template-columns: 1fr;
        }
    }

    .breadcrumb-custom {
        background: transparent;
        padding: 0;
        margin-bottom: 1.5rem;
    }

    .breadcrumb-custom .breadcrumb-item {
        font-size: 0.9rem;
    }

    .breadcrumb-custom .breadcrumb-item a {
        color: #667eea;
        text-decoration: none;
    }

    .breadcrumb-custom .breadcrumb-item a:hover {
        text-decoration: underline;
    }

    .stats-mini {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .stat-mini {
        background: white;
        padding: 1rem;
        border-radius: 8px;
        border-left: 3px solid #667eea;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

    .stat-mini-label {
        font-size: 0.85rem;
        color: #6c757d;
        margin-bottom: 0.25rem;
    }

    .stat-mini-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #212529;
    }
</style>

<div class="breadcrumb-custom">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('v4_config_list') }}">V4 Configuration</a></li>
            <li class="breadcrumb-item active">{{ schema.label }}</li>
        </ol>
    </nav>
</div>

<!-- Header -->
<div class="config-header">
    <h1>
        <i class="fas {{ schema.icon }} config-icon"></i>
        {{ schema.label }}
    </h1>
    <p>{{ schema.description }}</p>
</div>

<!-- Info Box -->
<div class="info-box">
    <h6><i class="fas fa-circle-info"></i> How to Use</h6>
    <p>Edit the configuration directly in the form below or use the JSON editor for advanced changes. All modifications are saved to GitHub with automatic commit messages.</p>
</div>

<!-- Main Editor Container -->
<form method="POST" id="configForm">
    <div class="editor-container">
        <!-- Form Editor Panel -->
        <div class="editor-panel">
            <div class="editor-panel-header">
                <h5>
                    <i class="fas fa-pen-to-square"></i> 
                    Form Editor
                </h5>
                <span class="badge bg-primary">Recommended</span>
            </div>
            <div class="editor-panel-body">
                <div id="formEditor"></div>
            </div>
        </div>

        <!-- JSON Editor Panel -->
        <div class="editor-panel">
            <div class="editor-panel-header">
                <h5>
                    <i class="fas fa-code"></i> 
                    JSON Editor
                </h5>
                <span class="badge bg-secondary">Advanced</span>
            </div>
            <div class="editor-panel-body">
                <textarea id="jsonEditor" class="json-editor" placeholder="JSON will appear here..."></textarea>
                <div id="validationResult" class="validation-result"></div>
            </div>
        </div>
    </div>

    <!-- Hidden input to store JSON data -->
    <input type="hidden" id="json_data" name="json_data" value="">

    <!-- Action Buttons -->
    <div class="action-buttons">
        <button type="button" class="btn-reset" id="resetBtn">
            <i class="fas fa-redo"></i> Reset Changes
        </button>
        <button type="submit" class="btn-save" id="saveBtn">
            <i class="fas fa-save"></i> Save to GitHub
        </button>
    </div>
</form>

<!-- Related Configs Section -->
<div class="mt-4">
    <h5 class="mb-3"><i class="fas fa-link me-2"></i>Other Configurations</h5>
    <div class="row">
        {% set configs = [
            ('ai_settings', 'AI Settings', 'fa-robot', 'Configure embedding and LLM models'),
            ('article_config', 'Article Configuration', 'fa-newspaper', 'Manage article templates'),
            ('search_config', 'Search Configuration', 'fa-search', 'Configure research questions'),
            ('config', 'Application Config', 'fa-cogs', 'API and scraping settings'),
            ('domain_reliability', 'Domain Reliability', 'fa-globe', 'Source reliability scores')
        ] %}
        
        {% for key, label, icon, desc in configs %}
            {% if key != config_key %}
            <div class="col-md-6 col-lg-4 mb-3">
                <a href="{{ url_for('edit_v4_config', config_key=key) }}" class="text-decoration-none">
                    <div class="card h-100" style="transition: all 0.3s ease; border: 1px solid #dee2e6;">
                        <div class="card-body">
                            <h6 class="card-title">
                                <i class="fas {{ icon }} me-2" style="color: #667eea;"></i>
                                {{ label }}
                            </h6>
                            <p class="card-text" style="font-size: 0.85rem; color: #6c757d;">{{ desc }}</p>
                        </div>
                    </div>
                </a>
            </div>
            {% endif %}
        {% endfor %}
    </div>
</div>

<script>
    // Configuration data
    const originalConfig = {{ json_str | safe }};
    const configKey = '{{ config_key }}';
    
    // Initialize editors
    function initializeEditors() {
        updateJsonEditor();
        populateFormEditor();
    }
    
    // Update JSON editor when form changes
    function updateJsonEditor() {
        try {
            const jsonStr = JSON.stringify(originalConfig, null, 2);
            document.getElementById('jsonEditor').value = jsonStr;
            document.getElementById('json_data').value = jsonStr;
        } catch (e) {
            console.error('Error updating JSON editor:', e);
        }
    }
    
    // Populate form editor based on config type
    function populateFormEditor() {
        const formEditor = document.getElementById('formEditor');
        formEditor.innerHTML = '';
        
        if (configKey === 'ai_settings') {
            renderAISettingsForm(formEditor);
        } else if (configKey === 'article_config') {
            renderArticleConfigForm(formEditor);
        } else if (configKey === 'search_config') {
            renderSearchConfigForm(formEditor);
        } else if (configKey === 'config') {
            renderApplicationConfigForm(formEditor);
        } else if (configKey === 'domain_reliability') {
            renderDomainReliabilityForm(formEditor);
        } else {
            renderGenericForm(formEditor);
        }
    }
    
    // Specific form renderers
    function renderAISettingsForm(container) {
        const html = `
            <div class="form-section">
                <div class="form-section-title">
                    <i class="fas fa-sliders-h"></i> Model Settings
                </div>
                <div class="form-group-custom">
                    <label>Embedding Model</label>
                    <select id="embedding_model" onchange="syncToJson()">
                        <option value="all-MiniLM-L6-v2" ${originalConfig.embedding_model === 'all-MiniLM-L6-v2' ? 'selected' : ''}>all-MiniLM-L6-v2</option>
                        <option value="all-mpnet-base-v2" ${originalConfig.embedding_model === 'all-mpnet-base-v2' ? 'selected' : ''}>all-mpnet-base-v2</option>
                    </select>
                    <div class="help-text">Model for converting text to embeddings</div>
                </div>
                
                <div class="form-group-custom">
                    <label>LLM Model</label>
                    <select id="llm_model" onchange="syncToJson()">
                        <option value="LiquidAI/LFM2-1.2B-RAG" ${originalConfig.llm_model === 'LiquidAI/LFM2-1.2B-RAG' ? 'selected' : ''}>LiquidAI/LFM2-1.2B-RAG</option>
                        <option value="meta-llama/Llama-2-7b" ${originalConfig.llm_model === 'meta-llama/Llama-2-7b' ? 'selected' : ''}>meta-llama/Llama-2-7b</option>
                        <option value="mistralai/Mistral-7B" ${originalConfig.llm_model === 'mistralai/Mistral-7B' ? 'selected' : ''}>mistralai/Mistral-7B</option>
                    </select>
                    <div class="help-text">Language model for generating articles</div>
                </div>
            </div>
            
            <div class="form-section">
                <div class="form-section-title">
                    <i class="fas fa-cogs"></i> Processing Settings
                </div>
                <div class="form-group-custom">
                    <label>Processing Device</label>
                    <select id="device" onchange="syncToJson()">
                        <option value="cpu" ${originalConfig.device === 'cpu' ? 'selected' : ''}>CPU</option>
                        <option value="cuda" ${originalConfig.device === 'cuda' ? 'selected' : ''}>CUDA (NVIDIA GPU)</option>
                        <option value="mps" ${originalConfig.device === 'mps' ? 'selected' : ''}>MPS (Apple Silicon)</option>
                    </select>
                    <div class="help-text">Device for model inference</div>
                </div>
                
                <div class="form-group-custom">
                    <label>Max Articles Per Run</label>
                    <input type="number" id="max_articles_per_run" value="${originalConfig.max_articles_per_run || 1}" min="1" max="10" onchange="syncToJson()">
                    <div class="help-text">Number of articles to generate per execution</div>
                </div>
                
                <div class="form-group-custom">
                    <label class="d-flex justify-content-between align-items-center">
                        <span>8-bit Quantization</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="load_in_8bit" ${originalConfig.load_in_8bit ? 'checked' : ''} onchange="syncToJson()">
                            <span class="slider"></span>
                        </label>
                    </label>
                    <div class="help-text">Reduces memory usage by ~75%</div>
                </div>
                
                <div class="form-group-custom">
                    <label class="d-flex justify-content-between align-items-center">
                        <span>Include Front Matter</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="include_front_matter" ${originalConfig.include_front_matter ? 'checked' : ''} onchange="syncToJson()">
                            <span class="slider"></span>
                        </label>
                    </label>
                    <div class="help-text">Add Jekyll YAML to generated articles</div>
                </div>
                
                <div class="form-group-custom">
                    <label class="d-flex justify-content-between align-items-center">
                        <span>Fetch Images</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="fetch_images" ${originalConfig.fetch_images ? 'checked' : ''} onchange="syncToJson()">
                            <span class="slider"></span>
                        </label>
                    </label>
                    <div class="help-text">Download images from Wikimedia Commons</div>
                </div>
            </div>
        `;
        container.innerHTML = html;
    }
    
    function renderArticleConfigForm(container) {
        const html = `
            <div class="form-section">
                <div class="form-section-title">
                    <i class="fas fa-image"></i> Image Settings
                </div>
                <div class="form-group-custom">
                    <label>Image Width</label>
                    <input type="number" value="${originalConfig.image_settings?.width || 800}" onchange="syncToJson()">
                </div>
                <div class="form-group-custom">
                    <label>Image Height</label>
                    <input type="number" value="${originalConfig.image_settings?.height || 600}" onchange="syncToJson()">
                </div>
            </div>
        `;
        container.innerHTML = html;
    }
    
    function renderSearchConfigForm(container) {
        const html = `
            <div class="form-section">
                <div class="form-section-title">
                    <i class="fas fa-search"></i> Search Settings
                </div>
                <div class="form-group-custom">
                    <label>Search Delay (seconds)</label>
                    <input type="number" step="0.1" value="${originalConfig.search?.delay || 1.5}" onchange="syncToJson()">
                    <div class="help-text">Delay between API requests</div>
                </div>
                <div class="form-group-custom">
                    <label>Max Sources</label>
                    <input type="number" value="${originalConfig.search?.max_sources || 20}" onchange="syncToJson()">
                </div>
            </div>
        `;
        container.innerHTML = html;
    }
    
    function renderApplicationConfigForm(container) {
        const html = `
            <div class="form-section">
                <div class="form-section-title">
                    <i class="fas fa-cogs"></i> API Settings
                </div>
                <div class="form-group-custom">
                    <label>Request Timeout</label>
                    <input type="number" value="${originalConfig.api?.request_timeout || 30}">
                    <div class="help-text">Timeout in seconds</div>
                </div>
            </div>
        `;
        container.innerHTML = html;
    }
    
    function renderDomainReliabilityForm(container) {
        const html = `
            <div class="info-box">
                <p>Domain reliability scores are managed through the JSON editor for accuracy. Scores range from 0.0 to 1.0.</p>
            </div>
        `;
        container.innerHTML = html;
    }
    
    function renderGenericForm(container) {
        const html = `
            <div class="info-box">
                <p>Use the JSON editor to modify this configuration.</p>
            </div>
        `;
        container.innerHTML = html;
    }
    
    // Sync form to JSON
    function syncToJson() {
        const config = originalConfig;
        
        // Update from form inputs
        document.querySelectorAll('input, select').forEach(el => {
            if (el.id && el.id !== 'json_data') {
                if (el.type === 'checkbox') {
                    config[el.id] = el.checked;
                } else if (el.type === 'number') {
                    config[el.id] = parseFloat(el.value) || parseInt(el.value);
                } else {
                    config[el.id] = el.value;
                }
            }
        });
        
        updateJsonEditor();
    }
    
    // Validate JSON
    function validateJson() {
        try {
            const json = document.getElementById('jsonEditor').value;
            JSON.parse(json);
            return true;
        } catch (e) {
            return false;
        }
    }
    
    // Form submission
    document.getElementById('configForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const jsonText = document.getElementById('jsonEditor').value;
        
        if (!validateJson()) {
            alert('Invalid JSON format. Please check the JSON editor.');
            return;
        }
        
        document.getElementById('json_data').value = jsonText;
        this.submit();
    });
    
    // Reset button
    document.getElementById('resetBtn').addEventListener('click', function() {
        if (confirm('Reset all changes?')) {
            location.reload();
        }
    });
    
    // JSON editor validation on input
    document.getElementById('jsonEditor').addEventListener('input', function() {
        const result = document.getElementById('validationResult');
        if (validateJson()) {
            result.className = 'validation-result success';
            result.innerHTML = '<strong>✓ Valid JSON</strong>';
        } else {
            result.className = 'validation-result error';
            result.innerHTML = '<strong>✗ Invalid JSON</strong>';
        }
    });
    
    // Initialize
    document.addEventListener('DOMContentLoaded', initializeEditors);
</script>

{% endblock %}